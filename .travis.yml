language: java
sudo: true
jdk:
  - openjdk11

cache:
  directories:
    - $HOME/.m2

jobs:
  include:
    - stage: build with maven & generate reports
      script:
        - mvn clean verify
    - stage: build docker images for server and agent
      if: NOT branch = master OR type IN (pull_request)
      script:
        - mvn validate docker:build@build-docker -P docker-app -f ./judge-d-server/pom.xml
        - mvn validate docker:build@build-docker -P docker-app -f ./judge-d-agent/pom.xml
    - stage: build & publish docker image for server
      script:
        - mvn validate docker:build@build-docker -P docker-app -f ./judge-d-server/pom.xml
        - echo "Pushing judge-d to docker registry"
        - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
        - docker push hltech/judge-d
    - stage: build & publish docker image for agent
      script:
        - mvn validate docker:build@build-docker -P docker-app -f ./judge-d-agent/pom.xml
        - echo "Pushing judge-d-agent to docker registry"
        - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
        - docker push hltech/judge-d-agent
